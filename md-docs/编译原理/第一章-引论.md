
# 第一章-引论

> 本节内容是关于编译原理的整体概览

只有很少的读者将回去构建甚至维护一个主流程序设计语言的编译器, **但是和编译器相关的模型,理论和算法可以被应用到软件设计和开发中出现的各种各样的问题上**. 因此我们会关注哪些在设计一个语言处理器时常常会遇到的问题, 而不考虑具体的源语言和目标机器究竟是什么

简单来说, 编译器是一个程序, 它可以阅读某一种语言便携的程序, 并把该程序翻译成一个等价的, 用另一种语言编写的程序. 编译器的重要任务之一就是报告它在翻译过程中发现的源程序中的错误

解释器是另一种常见的语言处理器, 它并不通过翻译的方式生成目标程序, 从用户的角度来看, 解释器直接利用用户提供的输入执行源程序中的指定操作

再把用户输入映射成为输出的过程中, 编译器产生的机器语言目标程序通常要比一个解释器快的多, 然而解释器的错误诊断效果通常要比编译器更好, 因为它逐个语句的执行源程序

> java 是一个非常经典的编译+解释的过程, java 源程序首先被编译为一个称为"字节码"的中间表示形式, 然后由一个虚拟机对得到的字节码加以解释执行. 这样的好处之一是在一台机器上编译得到的字节码可以在另一台机器上解释执行. 为了更快的完成输入到输出的处理, 特殊的处理方法比如即时编译器(just in time, JIT)

## 编译器的结构

分析(analysis)部分把源程序分解成为多个组成要素,并在这些要素之上加上语法结构.然后,它使用这个结构来创建该源程序的一个中间表示.如果分析部分检查出源程序没有按照正确的语法构成,或者语义上不一致,它就必须提供有用的信息,使得用户可以按此进行改正.分析部分还会收集有关源程序的信息,并把信息存放在一个称为符号表( symbol table)的数据结构中.符号表将和中间表示形式一起传送给综合部分.

综合(synthesis)部分根据中间表示和符号表中的信息来构造用户期待的目标程序.**分析部分经常被称为编译器的前端(front end),而综合部分称为后端(back end).**

下图是一个非常经典的编译执行顺序, 读者应该已经看过无数次了

![20230701231646](https://raw.githubusercontent.com/learner-lu/picbed/master/20230701231646.png)

有些编译器在前端和后端之间还有一个机器无关的**优化步骤**, 这个优化步骤的目的是在中间表示之上进行转换, 以便后端程序能够生成更好的目标程序

## 编程语言发展历史

当前有几千种程序设计语言.可以通过不同的方式对这些语言进行分类.方式之一是通过语言的代来分类.

- 第一代语言是机器语言
- 第二代语言是汇编语言
- 第三代语言是Fortran,Cobol、Lisp、C、C++、C#及Java这样的高级程序设计语言.
- 第四代语言是为特定应用设计的语言,比如用于生成报告的NOMAD,用于数据库查询的SQL和用于文本排版的 Postscript.
- 第五代语言指的是基于逻辑和约束的语言,比如Prolog和 OPS5.

另一种语言分类方式是按照语言的设计特性

- 把程序中指明如何完成一个计算任务的语言的称为强制式( imperative)语言

  诸如C、C++、C#和Java等语言都是强制式语言.所有强制式语言中都有用于表示程序状态和语句的表示方法,这些语句可以改变程序状态.

- 把程序中指明要进行哪些计算的语言称为声明式( declarative)语言.
  
  像ML、Haskell这样的函数式语言和Prolog这样的约束逻辑语言通常被认为是声明式语言.

面向对象语言( object-oriented language)指的是支持面向对象编程的语言,面向对象编程是指用一组相互作用的对象组成程序的编程风格.Simula67和Smaltalk是早期的主流面向对象语言.C++、C#、Java和 Ruby是现在常用的面向对象语言.

脚本语言( scripting language)是具有高层次运算符的解释型语言,它通常被用于把多个计算过程"粘合"在一起.这些计算过程被称为脚本.Awk 、JavaScript、Perl、PHP、Python、Ruby 和Tcl是常见的脚本语言.使用脚本语言编写的程序通常要比用其他语言(比如C)写的等价的程序短很多.

## 编译器的设计与挑战

编译器的设计中有很多通过数学方法抽象出问题本质从而解决现实世界中复杂问题的完美例子, 这些例子可以被用来说明如何使用抽象方法来解决问题:**接受一个问题,写出抓住了问题的关键特性的数学抽象表示,并用数学技术来解决它**.问题的表达必须根植于对计算机程序特性的深人理解,而解决方法必须使用经验来验证和精化.

编写编译器是很有挑战性的.编译器本身就是一个大程序.而且,很多现代语言处理系统在同一个框架内处理多种源语言和目标机.也就是说,这些系统可以被当做一组编译器来使用,可能包含几百万行代码.因此,**好的软件工程技术**对于创建和发展现代的语言处理器是非常重要的.

编译器必须能够正确翻译用源语言书写的所有程序.这样的程序的集合通常是无穷的.为一个源程序生成最佳目标代码的问题--般来说是不可判定的.因此,**编译器的设计者必须作出折衷处理,确定解决哪些问题,使用哪些启发式信息,以便解决高效代码生成的问题.**

## 优化

在编译器设计中,术语"优化"是指编译器为了生成比浅显直观的代码更加高效的代码而做的工作."优化"这个词并不恰当,因为没有办法保证一个编译器生成的代码比完成相同任务的任何其他代码更快,或至少一样快.

现在,编译器所作的代码优化变得更加重要,而且更加复杂.

- 之所以变得更加复杂,是因为处理器体系结构变得更加复杂,也有了更多改进代码执行方式的机会.
- 之所以变得更加重要,是因为巨型并发计算机要求实质性的优化,否则它们的性能将会呈数量级地下降.

随着多核计算机(这些计算机上的芯片拥有多个处理器)日益流行,所有的编译器都将面临充分利用多处理器计算机的优势的问题.

即使有可能通过随意的方法来建造一个健壮的编译器,实现起来也是非常困难的.因此,人们已经围绕代码优化建立了一套广泛且有用的理论.应用严格的数学基础,使得我们可以证明一个优化是正确的,并且它对所有可能的输入都产生预期的效果.如果想使得编译器产生经过良好优化的代码,**图、矩阵和线性规划**之类的模型是必不可少的.

从另一方面来说,只有理论是不够的.很多现实世界中的问题都没有完美的答案.实际上,我们在编译器优化中提出的很多问题都是不可判定的.在编译器设计中,**最重要的技能之一是明确描述出真正要解决的问题的能力**.我们在一开始需要对程序的行为有充分的了解,并且需要通过充分的试验和评价来验证我们的直觉.

编译器优化必须满足下面的设计目标:

- 优化必须是正确的,也就是说,不能改变被编译程序的含义.

  对正确性的强调是无论如何不会过分的.不管设计得到的编译器能够生成运行速度多么快的代码,只要生成的代码不正确,这个设计就是毫无意义的.

- 优化必须能够改善很多程序的性能.

  性能通常意味着程序执行的速度.我们也希望能够尽可能降低生成代码的大小,在嵌人式系统中更是如此.而对于移动设备的情况,尽量降低代码的能耗也是我们期待的.在通常情况下,提高执行效率的优化也能够节约能耗.除了性能,错误报告和调试等的可用性方面也是很重要的.

- 优化所需的时间必须保持在合理的范围内.
- 所需要的工程方面的工作必须是可管理的.

## 编译技术的应用

- 高级程序设计语言的实现
- 针对计算机体系结构的优化
  - 并行性
  - 内存层级
- 新计算机体系结构的设计
- 程序翻译
  - 二进制翻译
  - 硬件合成
  - SQL
  - 编译然后模拟
- 软件生产率工具
  - 类型检查
  - 边界检查
  - 内存管理工具

## 程序设计语言基础

### 静态与动态

在为一个语言设计一个编译器时,我们所面对的最重要的问题之一是编译器能够对一个程序做出哪些判定.

如果一个语言使用的策略支持编译器静态决定某个问题,那么我们说这个语言使用了静态( static)策略,或者说这个问题可以在编译时刻( compile time)决定.在静态语言中,变量的类型在编译时就被确定,这有助于在编译阶段捕获一些错误,提高代码的健壮性.

另一方面,一个只允许在运行程序的时候做出决定的策略被称为动态策略( dynamic policy),或者被认为需要在运行时刻(run time)做出决定.动态语言通常具有更灵活的语法和更简洁的语法结构,因为类型检查和类型转换由解释器或运行时环境处理

> 需要注意的是,并非所有的编程语言都能简单地归类为完全静态或完全动态.有些语言具有混合的特性,可以在一定程度上结合两种类型的特性

### JIT AOT

JIT(Just-in-Time)编译和AOT(Ahead-of-Time)编译都是编译器技术,用于将高级编程语言转换为可执行的机器码

JIT编译是一种将源代码在运行时逐行或逐块地编译成机器码的技术.它结合了解释执行和静态编译的优势. JIT编译器可以根据代码的执行情况动态优化生成的机器码,以提高程序的性能. JIT编译器通常会将**热点代码**(即频繁执行的代码)进行优化,而对于不频繁执行的代码,可能仍然采用解释执行的方式.由于在运行时进行编译,JIT编译会引入一定的**启动延迟**,但随着程序的执行,性能往往会逐渐提高

例如: 

- Java的HotSpot虚拟机:Java程序在运行时首先通过解释器执行,然后根据代码的执行情况,HotSpot虚拟机使用JIT编译器将热点代码编译成本地机器码,以提高程序的性能.
- JavaScript引擎:许多现代的JavaScript引擎,如V8(用于Chrome浏览器和Node.js)和SpiderMonkey(用于Firefox浏览器),使用JIT编译器将JavaScript代码转换为高效的机器码.
- .NET的Common Language Runtime(CLR):CLR使用JIT编译器将C#和其他.NET语言的代码转换为机器码.

AOT编译是一种在程序执行之前将源代码完全编译成机器码的技术.编译阶段就被完全转换为机器码,生成的机器码可以直接在目标平台上执行.AOT编译器将源代码转换为机器码时可以进行全局优化,因为它可以在编译阶段获取到整个程序的信息.AOT编译的程序启动时没有额外的编译延迟,在执行时不需要再进行额外的编译和优化,可以获得较快的执行速度

例如: C/C++, rust, go, unity

> 比如 Lua, 也有 LuaJIT

## 参考

- Bergin, T.J.and R.G. Gibson,History of Programming Languages,ACM Press,New York,1996.